# User Guide
This guide provides a step-by-step walkthrough for using TAS-Forge — from setting up the software environment to generating schedules, running simulations, and analyzing results.

Before getting started, please ensure that all required tools (MATLAB, IBM CPLEX, and OMNeT++) are properly installed and configured, along with any necessary dependencies. For details on supported versions and setup instructions, refer to the [Prerequisites](#prerequisites) section below.

For a deeper understanding of the tool's design, functionality, and scheduling model, see the [Technical Overview](Technical_Overview.md) documentation.

To review current limitations and known issues encoutered in the tool, refer to the [Known Issues and Limitations](Issues_and_Limitations.md) page.

## [Prerequisites](#prerequisites)
For implementing TAS-Forge, it is vital that the following software tools are installed correct and configured:

### 1. MATLAB
- Required for: Topology generation, CPLEX and OMNeT++ code generation, TAS schedule creation, and performance analysis from simulation outputs.
- Recommended Version: R2021b or later.
- Tip: Ensure MATLAB is added to your system’s environment PATH if you intend to run it from the terminal.

### 2. IBM CPLEX
- Required for: Solving TAS scheduling frameworks formulated as Integer Linear Programs (ILPs).
- Recommended Version: CPLEX Optimization Studio 22.1.1 or later.
- Installation Steps:
    - Download from the official [IBM CPLEX Download Page](https://www.ibm.com/support/pages/downloading-ibm-ilog-cplex-optimization-studio-2211).
- Note:
    - You may need to create an IBM account to access the download.
    - CPLEX must be run via the IBM GUI, as MATLAB integration is not supported in newer versions (22.x and beyond).

### 3. OMNeT++ 
- Required for: Simulating the generated network topology and validate the TAS schedule execution.
- Recommended Version: OMNeT++ 6.0.1 or newer.
- Dependencies: Requires INET version 4.4.
- Installation Steps:
    - Download OMNeT++ from the [OMNeT++ Download Page](https://omnetpp.org/download/).
    - Download INET from the [INET Download Page](https://inet.omnetpp.org/2022-05-16-INET-4.4.0-released.html).
- Note:
    - The .ned and .ini files generated by TAS-Forge should be imported in an OMNeT++ project for simulation.
- Important:
    - To enable processing delays within network devices, modifications are required in the INET framework of OMNeT++. Please follow the steps outlined in the [Modifications to INET](Modifications_INET) page to complete the setup.

### 4. TAS-Forge Repository
To get the project code:

<pre> git clone https://github.com/AviroopGhosh/TAS-Forge.git </pre>

Or you can download it as a ZIP file and extract it. 

## [Folder Structure](#folder_structure)

<pre>
    TAS-Forge/codes/
    ├── function_generate_routes.m         % Function to generate pair of sources and sinks to form routes
    ├── function_generate_topology_map.m   % Function used to generate the topology map incl. source and destination ports
    ├── function_import_topology_data.m    % This funcition is used to import the topology-related data  
    ├── generate_CPLEX_code_NCA.m          % Generate CPLEX input files based on Network-Derived Clock Drift Adustment (NCD) scheduling framework
    ├── generate_CPLEX_code_NCD.m          % Generate CPLEX input files based on Network-Derived Clock Drift Delay (NCD) scheduling framework
    ├── generate_CPLEX_code_WCA.m          % Generate CPLEX input files based on Worst-case Adjustment (WCA) scheduling framework
    ├── generate_CPLEX_code_WCD.m          % Generate CPLEX input files based on Worst-case Delay (WCD) scheduling framework
    ├── generate_GCL_output.m              % Generate Gate Control Lists (GCLs) based on the scheduling framework selected    
    ├── generate_network_system.m          % Starting script used to generate the network topology, routes and stream parameters
    ├── generate_omntepp_files.m           % Generates both NED and INI files for OMNeT++ simulation
    ├── generate_omnetpp_ini_file.m        % This script generates the INI file for simulation
    ├── generate_omnetpp_ned_file.m        % This script generates the NED file to load into OMNeT++ 
    ├── input_cplex_solution.txt           % Text file to paste solution generated by CPLEX
    ├── network_data.csv                   % Generated network data for scheduling (created by running generate_network_systems.m)
    ├── node_data.csv                      % Records clock drift values for nodes (created by running generate_network_systems.m)
    ├── output_GCL_matrix.txt              % Output of GCLs of all relevant egress ports (created by running generate_GCL_output.m)
    ├── port_connections.csv               % Port connection list of all devices to neighbouring nodes (created by running generate_network_systems.m)
    ├── stream_data.csv                    % Lists stream parameters incl. routes, periodicity, etc. (created by running generate_network_systems.m)
    ├── CPLEX_Code_Output/                 % Directory for all CPLEX model output files (created by running generate_network_systems.m)
        ├── output_CPLEX_code_NCA.mod      % CPLEX input file for NCA scheduling method (created by running generate_CPLEX_code_NCA.m)          
        ├── output_CPLEX_code_NCD.mod      % CPLEX input file for NCD scheduling method (created by running generate_CPLEX_code_NCD.m)  
        ├── output_CPLEX_code_WCA.mod      % CPLEX input file for WCA scheduling method (created by running generate_CPLEX_code_WCA.m)  
        ├── output_CPLEX_code_WCD.mod      % CPLEX input file for WCD scheduling method (created by running generate_CPLEX_code_WCD.m) 
    ├── OMNETpp_Code_Output/               % Directory containing the ini and ned files (created by running generate_omnetpp_files.m)
        ├── generated_topology.ned         % Ned file generated
        ├── simulation_config_[sched].ini  % Ini file generated based on scheduler type  
</pre>

## Step-by-Step Guide: Using TAS-Forge
This section provides a step-by-step guide for using TAS-Forge. Before beginning, ensure that all the required files are present in your MATLAB working directory. To understand how the files are organized, refer to the [Folder Structure](#folder_structure) section. 

**Note:** Many files (e.g., CSV exports, CPLEX input, OMNeT simulation files) are generated during execution. These files will not appear until their corresponding scripts have been run. This will be highlighted in the respective steps. 

### Step 1: Generate Network Topology and Stream Parameters
To being using TAS-Forge, run the following script in MATLAB:

<pre>
    generate_network_system
</pre>

The script will prompt the user to input:
- Number of sources
- Number of sinks
- Number of switches

Once provided, the script will automatically create the following:
- A linear network topology consisting of the network devices with a visually representative figure
- A set of routes connecting each source to at least one or more sink nodes
- Set of streams per route with the following properties:
    - Payload size
    - Transmission Periodicity
    - Deadline constraint

**Note:** Each source must be connected to at least one sink. Isolated devices (sources or sinks with no valid route) are not supported. If this occurs, the script will prompt a re-run with adjusted device settings.
For more details, see the [Known Issues and Limitations](documentation/Issues_and_Limitations.md) page. 

The script exports the following files:
- `stream_data.csv` - Contains configuration parameters for each time-sensitive stream, including payload, periodicity, and deadlines.
- `network_data.csv` - Stores global network parameters such as hyperperiod, macroticks, synchronization periodicity etc. 
- `node_data.csv` - Contains randomly assigned clock drift values for each network node, used for the time synchronization and TAS scheduling process. 
- `port_connections.csv`- Contains information about each egress port in the network, including its connected neighboring device and the list of streams routed.

The script also executes all the following scripts. Each script generates a CPLEX-compatible text file containing the integer linear programming formulation for TAS schedule computation:
- `generate_CPLEX_code_NCA.m` - Generates CPLEX input file based on the NCA scheduling method 
- `generate_CPLEX_code_NCD.m` - Generates CPLEX input file based on the NCD scheduling method
- `generate_CPLEX_code_WCA.m` - Generates CPLEX input file based on the WCA scheduling method
- `generate_CPLEX_code_WCD.m` - Generates CPLEX input file based on the WCD scheduling method

The `generate_network_systems.m` script automatically creates a directory `CPLEX_Code_Output/`, and the corresponding CPLEX model (.mod) files are generated:
- `output_CPLEX_code_NCA.mod`
- `output_CPLEX_code_NCD.mod`
- `output_CPLEX_code_WCA.mod`
- `output_CPLEX_code_WCD.mod`

Finally, a blank text file `input_cplex_solution.txt` is created. This file is used to manually paste the GCL offset values (the decision variables) obtained after solving the CPLEX model. This is explained in Step 2.

### Step 2: Execute CPLEX Code
This step is a manual process, as MATLAB does not currently support integration with the required version of IBM CPLEX. 

Using the CPLEX model files generated in the previous step, select one of the scheduling frameworks (e.g., NCA, NCD, WCA and WCD) and run it using IBM CPLEX Optimization Studio. 

**Important:** Before proceeding, ensure that **CPLEX is properly installed and configured.**

To execute the model file:
1. Launch CPLEX Optimization Studio and create a new OPL Project.
2. Add the corresponding `.mod` file generated in the `CPLEX_Code_Output/` folder generated by TAS-Forge.
3. Create a Run Configuration within the OPL project for the `.mod`.
4. Run the model to compute the TAS schedule.

Once the model is executed, check the **Problem Browser** tab in CPLEX studio.
- If the decision variables display **"No Value"**, this indicates that the CPLEX model could not find a feasible solution.
- Refer to the [Technical Overview](documentation/Technical_Overview.md) documentation for possible causes and rectifications.

If the model **sucessfully outputs** decision varables, proceed with the following steps:
1. Go to the "Solution" tab in the output area at the bottom of CPLEX studio.
2. You will see all the decision variables (e.g., `OFF_1_source1`,`OFF_1_switch1`,`OFF_2_switch1`, etc.).
3. Copy **all** the decision variables into the text `input_cplex_solution.txt` (generated from Step 1) file.
4. Ensure that the decision variables are in a format, `VARIABLE_NAME = VALUE;`, for example: `OFF_1_source1 = 0;` or `OFF_1_switch1 = 10;`.

### Step 3: Create Gate Control Lists (GCLs)
This step processes the output from CPLEX to create the Gate Control Lists (GCLs) used for TAS scheduling.

For sucessful GCL creation the following steps need to be followed:
1. Run the script `generate_GCL_output.m` in MATLAB.
2. The script will prompt to enter the type of scheduler type used in your CPLEX run, e.g. `WCA`,`WCD`,`NCA`,or `NCD`.
3. Enter the scheduler name **exactly as shown**, the input is **case-sensitive**, an incorrect entry will result in an error.
4. The script will then read the CPLEX output file from the decision variables pasted in `input_cplex_solution.txt`.
   
    **Note:** If any of the decision variables are missing or have not been copied correctly from the CPLEX output then the script will terminate with an error indicating which variable could not be found.
   In that case, you will need to verify and copy the missing decision variable from the CPLEX output before running the script again.
5. The script will generate an output file `Output_GCL_matrix.txt`, which constains the computed GCLs.
6. A schedulability cost metric will also be output as part of the result, providing insight into the efficiency of the generated schedule.

**Important:** If the script generates an error citing 'overlapping conditions' then refer to [Known Issues and Limitations](documentation/Issues_and_Limitations.md) page for guidance. 

**Note:** The `Output_GCL_matrix.txt` file contains a list of generated GCLs. Each line corresponds to the GCL for a specifc switch egress port and is aligned with the respective row in the `port_connections.csv` file. In this context:
- **Source** refers to the switch device.
- **SourcePort** indicates the egress port on which the GCL is applied. 

All GCL entries are expressed in **microseconds**. 

For an understanding on how to interpret the GCLs refer to the [Technical Overview](documentation/Technical_Overview.md) page.

### Step 4: Generate Simulation Configuration
Following the previous step, this stage generates the required OMNeT++ simulation files, namely the `.ned` and `.ini` files. 

Run the following script in MATLAB:
<pre>
    generate_omnetpp_files
</pre>

This script will:
- Automatically create a new new directory `OMNETpp_Code_Output` if one doesn't already exist. 
- Interally call the scripts `generate_omnetpp_ned_file.m` and `generate_omnetpp_ini_file.m` to generate the necessary simulation files.
- The script will not proceed if the previous steps have not been completed.

The script outputs the following:
- A **network topology map** that visually represents the direction of flow of traffic defined in the generated `.ned` file.
- The following output files are created in the `OMNETpp_Code_Output` directory:
      - `generated_topology.ned` representing the network structure in the OMNeT++ simulation.
      - `simulation_config_[sched]` representing the corresponding simulation configuration file, where `[sched]` indicates the specific TAS scheduling method used such as, `WCD`,`WCA`, etc. 

The files generated in the `OMNETpp_Code_Output` can be imported into an OMNET++ project for execution. 

**Important:** Ensure that you have completed the modifications required in INET from the [Modifications to INET](Modifications_INET) page first before proceeding to simulating in OMNeT++. 

### Step 5: Analyzing Simulation Results
After loading the `.ned` and `.ini` files in OMNeT++, run the `.ini` file to start the simulation. 

**Note:** By default, the simulation executes for a duration of 1 second. To modify the simulation duration, adjust the `sim-time-limit` parameter in the `.ini` file.

**Important:** If the simulation generates an error citing 'clock synchronization overdue' then refer to [Known Issues and Limitations](documentation/Issues_and_Limitations.md) page for guidance. 

After **successful** completion of the simulation:
- Open the vector results generated by the OMNeT++ simulation. 
- Filter the results using 'meanBitLifeTimePerPacket:vector' in the results column.
- These values represent the end-to-end latency of each frame, sorted by the stream as received at the sink.
- Export the results and save the file as `results.csv`.
- The `.csv` file should be visible in the *Results* section in Project Explorer in OMNeT++.
- Move this file to your MATLAB directory containing the TAS-Forge files.

